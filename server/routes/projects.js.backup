const express = require('express');
const router = express.Router();
const Project = require('../models/Project');
const auth = require('../middleware/auth');

// @route   GET /api/projects
// @desc    Get all projects with optional filtering
// @access  Public
// @query   type (photography, videography, web-development, other)
// @query   status (draft, in-progress, completed, archived)
router.get('/', async (req, res) => {
    try {
        const { type, status } = req.query;
        const filter = {};

        // Apply filters if provided
        if (type) {
            filter.type = type;
        }
        if (status) {
            filter.status = status;
        }

        const projects = await Project.find(filter).sort({ order: 1, createdAt: -1 });

        res.json({
            success: true,
            count: projects.length,
            data: projects
        });
    } catch (error) {
        console.error('Get projects error:', error);
        res.status(500).json({
            success: false,
            message: 'Failed to fetch projects',
            error: error.message
        });
    }
});

// @route   GET /api/projects/featured
// @desc    Get featured projects
// @access  Public
router.get('/featured', async (req, res) => {
    try {
        const projects = await Project.find({ featured: true }).sort({ order: 1, createdAt: -1 });

        res.json({
            success: true,
            count: projects.length,
            data: projects
        });
    } catch (error) {
        console.error('Get featured projects error:', error);
        res.status(500).json({
            success: false,
            message: 'Failed to fetch featured projects',
            error: error.message
        });
    }
});

// @route   GET /api/projects/:id
// @desc    Get single project
// @access  Public
router.get('/:id', async (req, res) => {
    try {
        const project = await Project.findById(req.params.id);

        if (!project) {
            return res.status(404).json({
                success: false,
                message: 'Project not found'
            });
        }

        res.json({
            success: true,
            data: project
        });
    } catch (error) {
        console.error('Get project error:', error);
        res.status(500).json({
            success: false,
            message: 'Failed to fetch project',
            error: error.message
        });
    }
});

// @route   POST /api/projects
// @desc    Create new project
// @access  Private (Admin only)
router.post('/', auth, async (req, res) => {
    try {
        const {
            title,
            description,
            imageUrl,
            coverImage,
            type,
            media,
            clientName,
            invoiceId,
            status,
            completedDate,
            tags,
            projectUrl,
            featured,
            order
        } = req.body;

        // Validation
        if (!title || !description) {
            return res.status(400).json({
                success: false,
                message: 'Please provide title and description'
            });
        }

        const project = new Project({
            title,
            description,
            imageUrl: imageUrl || coverImage || '', // Backward compatibility
            coverImage: coverImage || imageUrl || '',
            type: type || 'other',
            media: media || [],
            clientName,
            invoiceId,
            status: status || 'draft',
            completedDate,
            tags: tags || [],
            projectUrl,
            featured: featured || false,
            order: order || 0
        });

        await project.save();

        res.status(201).json({
            success: true,
            message: 'Project created successfully',
            data: project
        });
    } catch (error) {
        console.error('Create project error:', error);
        res.status(500).json({
            success: false,
            message: 'Failed to create project',
            error: error.message
        });
    }
});

// @route   PUT /api/projects/:id
// @desc    Update project
// @access  Private (Admin only)
router.put('/:id', auth, async (req, res) => {
    try {
        const {
            title,
            description,
            imageUrl,
            coverImage,
            type,
            media,
            clientName,
            invoiceId,
            status,
            completedDate,
            tags,
            projectUrl,
            featured,
            order
        } = req.body;

        const updateData = {
            updatedAt: Date.now()
        };

        // Only update fields that are provided
        if (title !== undefined) updateData.title = title;
        if (description !== undefined) updateData.description = description;
        if (imageUrl !== undefined) updateData.imageUrl = imageUrl;
        if (coverImage !== undefined) updateData.coverImage = coverImage;
        if (type !== undefined) updateData.type = type;
        if (media !== undefined) updateData.media = media;
        if (clientName !== undefined) updateData.clientName = clientName;
        if (invoiceId !== undefined) updateData.invoiceId = invoiceId;
        if (status !== undefined) updateData.status = status;
        if (completedDate !== undefined) updateData.completedDate = completedDate;
        if (tags !== undefined) updateData.tags = tags;
        if (projectUrl !== undefined) updateData.projectUrl = projectUrl;
        if (featured !== undefined) updateData.featured = featured;
        if (order !== undefined) updateData.order = order;

        const project = await Project.findByIdAndUpdate(
            req.params.id,
            updateData,
            { new: true, runValidators: true }
        );

        if (!project) {
            return res.status(404).json({
                success: false,
                message: 'Project not found'
            });
        }

        res.json({
            success: true,
            message: 'Project updated successfully',
            data: project
        });
    } catch (error) {
        console.error('Update project error:', error);
        res.status(500).json({
            success: false,
            message: 'Failed to update project',
            error: error.message
        });
    }
});

// @route   DELETE /api/projects/:id
// @desc    Delete project
// @access  Private (Admin only)
router.delete('/:id', auth, async (req, res) => {
    try {
        const project = await Project.findByIdAndDelete(req.params.id);

        if (!project) {
            return res.status(404).json({
                success: false,
                message: 'Project not found'
            });
        }

        res.json({
            success: true,
            message: 'Project deleted successfully'
        });
    } catch (error) {
        console.error('Delete project error:', error);
        res.status(500).json({
            success: false,
            message: 'Failed to delete project',
            error: error.message
        });
    }
});

// @route   POST /api/projects/:id/media
// @desc    Add media to project
// @access  Private (Admin only)
router.post('/:id/media', auth, async (req, res) => {
    try {
        const { url, type, caption, order } = req.body;

        // Validation
        if (!url || !type) {
            return res.status(400).json({
                success: false,
                message: 'Please provide url and type'
            });
        }

        if (!['image', 'video'].includes(type)) {
            return res.status(400).json({
                success: false,
                message: 'Type must be either image or video'
            });
        }

        const project = await Project.findById(req.params.id);

        if (!project) {
            return res.status(404).json({
                success: false,
                message: 'Project not found'
            });
        }

        // Add new media item
        const newMedia = {
            url,
            type,
            caption: caption || '',
            order: order !== undefined ? order : project.media.length
        };

        project.media.push(newMedia);
        project.updatedAt = Date.now();
        await project.save();

        res.status(201).json({
            success: true,
            message: 'Media added successfully',
            data: project
        });
    } catch (error) {
        console.error('Add media error:', error);
        res.status(500).json({
            success: false,
            message: 'Failed to add media',
            error: error.message
        });
    }
});

// @route   DELETE /api/projects/:id/media/:mediaId
// @desc    Remove media from project
// @access  Private (Admin only)
router.delete('/:id/media/:mediaId', auth, async (req, res) => {
    try {
        const project = await Project.findById(req.params.id);

        if (!project) {
            return res.status(404).json({
                success: false,
                message: 'Project not found'
            });
        }

        // Find and remove the media item
        const mediaIndex = project.media.findIndex(
            item => item._id.toString() === req.params.mediaId
        );

        if (mediaIndex === -1) {
            return res.status(404).json({
                success: false,
                message: 'Media not found'
            });
        }

        project.media.splice(mediaIndex, 1);
        project.updatedAt = Date.now();
        await project.save();

        res.json({
            success: true,
            message: 'Media removed successfully',
            data: project
        });
    } catch (error) {
        console.error('Remove media error:', error);
        res.status(500).json({
            success: false,
            message: 'Failed to remove media',
            error: error.message
        });
    }
});

// @route   PUT /api/projects/:id/media/reorder
// @desc    Reorder media in project
// @access  Private (Admin only)
router.put('/:id/media/reorder', auth, async (req, res) => {
    try {
        const { mediaOrder } = req.body;

        // Validation
        if (!Array.isArray(mediaOrder)) {
            return res.status(400).json({
                success: false,
                message: 'mediaOrder must be an array of {mediaId, order} objects'
            });
        }

        const project = await Project.findById(req.params.id);

        if (!project) {
            return res.status(404).json({
                success: false,
                message: 'Project not found'
            });
        }

        // Update order for each media item
        mediaOrder.forEach(({ mediaId, order }) => {
            const mediaItem = project.media.find(
                item => item._id.toString() === mediaId
            );
            if (mediaItem) {
                mediaItem.order = order;
            }
        });

        // Sort media array by order
        project.media.sort((a, b) => a.order - b.order);
        project.updatedAt = Date.now();
        await project.save();

        res.json({
            success: true,
            message: 'Media reordered successfully',
            data: project
        });
    } catch (error) {
        console.error('Reorder media error:', error);
        res.status(500).json({
            success: false,
            message: 'Failed to reorder media',
            error: error.message
        });
    }
});

module.exports = router;
